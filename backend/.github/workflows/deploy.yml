name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  GAR_LOCATION: us-central1
  REPOSITORY: final-ing-3-repo
  BACKEND_SERVICE_QA: final-ing-3-api-qa-quelas-rivero
  BACKEND_SERVICE_PROD: final-ing-3-api-prod-quelas-rivero
  FRONTEND_SERVICE_QA: final-ing-3-web-qa-quelas-rivero
  FRONTEND_SERVICE_PROD: final-ing-3-web-prod-quelas-rivero

jobs:
  tests:
    uses: ./.github/workflows/ci.yml

  build-backend:
    name: Build Backend Image
    needs: tests
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      REGISTRY_HOST: ${{ secrets.GCP_REGION }}-docker.pkg.dev
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: echo "image=${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/backend:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build backend image
        run: docker build -f backend/Dockerfile -t ${{ steps.vars.outputs.image }} .

      - name: Push backend image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  build-frontend-qa:
    name: Build Frontend Image (QA)
    needs: tests
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      REGISTRY_HOST: ${{ secrets.GCP_REGION }}-docker.pkg.dev
      API_URL: ${{ secrets.QA_API_URL }}
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: echo "image=${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/frontend-qa:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build frontend image
        run: docker build -f frontend/Dockerfile --build-arg API_URL="${API_URL}" -t ${{ steps.vars.outputs.image }} .

      - name: Push frontend image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  deploy-backend-qa:
    name: Deploy Backend to QA
    needs: build-backend
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE_QA }}
          image: ${{ needs.build-backend.outputs.image }}
          region: ${{ secrets.GCP_REGION }}
          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL_QA }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            SESSION_SECRET_KEY=${{ secrets.SESSION_SECRET_KEY }}
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_PASS=${{ secrets.EMAIL_PASS }}
            SMTP_SERVER=${{ secrets.SMTP_SERVER }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
            GEMINI_MODEL=${{ secrets.GEMINI_MODEL }}
            ENVIRONMENT=qa
          flags: --allow-unauthenticated

  deploy-frontend-qa:
    name: Deploy Frontend to QA
    needs: build-frontend-qa
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE_QA }}
          image: ${{ needs.build-frontend-qa.outputs.image }}
          region: ${{ secrets.GCP_REGION }}
          env_vars: |
            PORT=8080
          flags: --allow-unauthenticated

  integration-tests:
    name: Integration Tests (post-QA)
    needs:
      - deploy-backend-qa
      - deploy-frontend-qa
    runs-on: ubuntu-latest
    env:
      DATABASE_URL: ${{ secrets.DATABASE_URL_QA }}
      QA_BASE_URL: ${{ secrets.QA_API_URL }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install dependencies
        run: pip install -r backend/requirements.txt

      - name: Prepare Google credentials
        if: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON != '' }}
        env:
          CREDS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        run: |
          printf '%s' "$CREDS_JSON" > $HOME/gcp-creds.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=$HOME/gcp-creds.json" >> $GITHUB_ENV

      - name: Run integration tests
        working-directory: backend
        run: pytest -m integration --junitxml=pytest-integration.xml

      - name: Upload integration report
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-tests
          path: backend/pytest-integration.xml
          if-no-files-found: ignore

  approval-prod:
    name: Approval for Production
    needs: integration-tests
    runs-on: ubuntu-latest
    environment:
      name: production
    steps:
      - run: echo "Approve this job to continue with production deployment."

  deploy-backend-prod:
    name: Deploy Backend to Production
    needs:
      - approval-prod
      - build-backend
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE_PROD }}
          image: ${{ needs.build-backend.outputs.image }}
          region: ${{ secrets.GCP_REGION }}
          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL_PROD }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            SESSION_SECRET_KEY=${{ secrets.SESSION_SECRET_KEY }}
            EMAIL_USER=${{ secrets.EMAIL_USER }}
            EMAIL_PASS=${{ secrets.EMAIL_PASS }}
            SMTP_SERVER=${{ secrets.SMTP_SERVER }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
            GEMINI_MODEL=${{ secrets.GEMINI_MODEL }}
            ENVIRONMENT=production
          flags: --allow-unauthenticated

  build-frontend-prod:
    name: Build Frontend Image (Prod)
    needs: approval-prod
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      REGISTRY_HOST: ${{ secrets.GCP_REGION }}-docker.pkg.dev
      API_URL: ${{ secrets.PROD_API_URL }}
    outputs:
      image: ${{ steps.publish.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker auth
        run: gcloud auth configure-docker $REGISTRY_HOST

      - id: vars
        run: echo "image=${REGISTRY_HOST}/${PROJECT_ID}/${REPOSITORY}/frontend-prod:${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build frontend image
        run: docker build -f frontend/Dockerfile --build-arg API_URL="${API_URL}" -t ${{ steps.vars.outputs.image }} .

      - name: Push frontend image
        run: docker push ${{ steps.vars.outputs.image }}

      - id: publish
        run: echo "image=${{ steps.vars.outputs.image }}" >> $GITHUB_OUTPUT

  deploy-frontend-prod:
    name: Deploy Frontend to Production
    needs:
      - build-frontend-prod
    runs-on: ubuntu-latest
    steps:
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.FRONTEND_SERVICE_PROD }}
          image: ${{ needs.build-frontend-prod.outputs.image }}
          region: ${{ secrets.GCP_REGION }}
          env_vars: |
            PORT=8080
          flags: --allow-unauthenticated
